---
interface Org {
  name?: string;
  url?: string;
  logoUrl?: string;
  logoW?: number;
  logoH?: number;
  description?: string;        // About Us
  teamNotes?: string[];        // Our Team (descriptions)
  services?: { name: string; description?: string }[]; // Our Services
  locations?: {
    name: string;
    streetAddress?: string;
    postalCode?: string;
    addressLocality?: string;
    addressCountry?: string;   // ISO: FR, PH, etc.
    email?: string;
  }[];                          // Localization
  contactEmail?: string;        // Contact Us
}

interface Page {
  url: string;                  // absolute
  pageType?: 'AboutPage' | 'ContactPage' | 'CollectionPage' | 'WebPage';
  name?: string;
  description?: string;
}

interface Props {
  org: Org;
  page: Page;
  includeWebsite?: boolean;
}

const { org, page, includeWebsite = true } = Astro.props as Props;

// --- Build Organization node (ordered sections) ---
const orgNode: any = {
  "@type": "Organization",
  "@id": `${org.url}#org`,
  "name": org.name,
  "url": org.url,
  "logo": {
    "@type": "ImageObject",
    "url": org.logoUrl,
    "width": org.logoW ?? 512,
    "height": org.logoH ?? 512
  }
};

// 1) About Us
if (org.description) orgNode.description = org.description;

// 2) Our Team (descriptions only)
if (org.teamNotes?.length) orgNode.knowsAbout = org.teamNotes;

// 3) Our Services
if (org.services?.length) {
  orgNode.makesOffer = org.services.map(svc => ({
    "@type": "Offer",
    "itemOffered": {
      "@type": "Service",
      "name": svc.name,
      ...(svc.description ? { "description": svc.description } : {})
    }
  }));
}

// 4) Localization (offices)
if (org.locations?.length) {
  orgNode.department = org.locations.map(loc => ({
    "@type": "LocalBusiness",
    "name": loc.name,
    ...(loc.email ? { "email": loc.email } : {}),
    ...(loc.streetAddress || loc.addressLocality || loc.addressCountry || loc.postalCode
      ? {
          "address": {
            "@type": "PostalAddress",
            ...(loc.streetAddress ? { "streetAddress": loc.streetAddress } : {}),
            ...(loc.postalCode ? { "postalCode": loc.postalCode } : {}),
            ...(loc.addressLocality ? { "addressLocality": loc.addressLocality } : {}),
            ...(loc.addressCountry ? { "addressCountry": loc.addressCountry } : {})
          }
        }
      : {})
  }));
}

// 5) Contact Us
if (org.contactEmail) {
  orgNode.contactPoint = [{
    "@type": "ContactPoint",
    "email": org.contactEmail,
    "contactType": "customer support",
    "availableLanguage": ["en", "fr"]
  }];
}

// --- Page node ---
const pageNode: any = {
  "@type": page.pageType ?? "WebPage",
  "@id": `${page.url}#page`,
  "url": page.url,
  ...(page.name ? { "name": page.name } : {}),
  ...(page.description ? { "description": page.description } : {}),
  "about": { "@id": `${org.url}#org` }
};

// --- Optional WebSite node for sitelinks ---
const websiteNode: any = includeWebsite ? {
  "@type": "WebSite",
  "@id": `${org.url}#website`,
  "url": org.url,
  "name": org.name,
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${org.url}search?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
} : null;

const graph = [orgNode, pageNode, ...(websiteNode ? [websiteNode] : [])];

// Helper: stable, compact JSON string without escaping in HTML
const json = JSON.stringify({ "@context": "https://schema.org", "@graph": graph });
---
<!-- IMPORTANT: use set:html so Google sees raw JSON, not escaped text -->
<script type="application/ld+json" set:html={json}></script>
